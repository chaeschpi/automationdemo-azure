#cloud-config
package_upgrade: true
packages:
  - curl
output: {all: '| tee -a /var/log/cloud-init-output.log'}
runcmd:
  - curl -s https://github.com/tuxpeople.keys >> /home/adminuser/.ssh/authorized_keys
  - sudo parted /dev/sdc --script -- mklabel gpt
  - sudo parted /dev/sdc --script -- mkpart primary 0% 100%
  - sudo mkfs.ext4 /dev/sdc1
  - sudo mkdir -p /data
  - sudo echo "$(blkid /dev/sdc1 -s UUID | cut -d' ' -f2) /data ext4 defaults 0 0" | sudo tee -a /etc/fstab > /dev/null
  - sudo mount -a
  - curl -sfL https://get.k3s.io | sh -s - --data-dir /data/k3s
  - until [ "$(sudo k3s kubectl get nodes | awk '{ print $2 }' | tail -1)" = "Ready" ]; do sleep 10; done
  - curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
  - helm repo add rancher-latest https://releases.rancher.com/server-charts/latest
  - kubectl create namespace cattle-system
  - kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v1.3.1/cert-manager.crds.yaml
  - kubectl create namespace cert-manager
  - helm repo add jetstack https://charts.jetstack.io
  - helm repo update
  - export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
  - helm install cert-manager jetstack/cert-manager --namespace cert-manager --version v1.3.1
  - sudo k3s kubectl -n cert-manager rollout status deploy/cert-manager
  - sudo k3s kubectl -n cert-manager rollout status deploy/cert-manager-cainjector
  - sudo k3s kubectl -n cert-manager rollout status deploy/cert-manager-webhook
  - curl -s https://fluxcd.io/install.sh | sudo bash
  - sudo flux bootstrap github --owner=tuxpeople --repository=automationdemo-kubernetes --branch=master --personal --private-key-file=/home/adminuser/key
#  - dig +short -x $(curl -s http://ipv4.icanhazip.com) | sed 's/\.$//' > /tmp/rancherurl
#  - helm install rancher rancher-latest/rancher --namespace cattle-system --set hostname=$(cat /tmp/rancherurl) --set replicas=1 --set letsEncrypt.email=thomas@tuxpeople.org --set ingress.tls.source=letsEncrypt
#  - until [ "$(curl -sfL https://$(cat /tmp/rancherurl)/ping)" = "Pong" ]; do echo "Waiting for Rancher to come up..."; sleep 30; done